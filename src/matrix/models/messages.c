/*response on /messages endpoint with lazyload enabled

{"start":"t77772_1713992225995","start_stream":"s1712992052694_1712184365130_1712386619718_1712389416169_0_0_0.pd-IUdTOGtVN3FLVE15ZGk1Z0JyU2hRdGc6cmVkZGl0LmNvbQ-1713992225995-l","end":"t77762_1713988306240","chunk":[{"content":{"membership":"leave"},"event_id":"$93MPc1vv55z6B0LUgprh9W6dUM7TXspJf1pGnZdxMcc","origin_server_ts":1713992225977,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_kkw8yoro:reddit.com","state_key":"@t2_kkw8yoro:reddit.com","type":"m.room.member","unsigned":{"age":2109960,"com_reddit_subreddit_id":"t5_2qyps"}},{"content":{"body":"nice","msgtype":"m.text"},"event_id":"$nAF01Cp0dwrf-NbU1hSCE3oeeNunu8jzvQSbZ7y_n6E","origin_server_ts":1713992221470,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_kkw8yoro:reddit.com","type":"m.room.message","unsigned":{"age":2114467,"com_reddit_subreddit_id":"t5_2qyps"}},{"content":{"body":"image_apr. 24, 2024_10:50_0.jpeg","com.reddit.blurred_url":"mxc://reddit.com/blur_7khn5ckqphwc1","com.reddit.nsfw_image":false,"info":{"h":960,"mimetype":"image/jpeg","size":97797,"w":1280},"msgtype":"m.image","url":"mxc://reddit.com/7khn5ckqphwc1"},"event_id":"$UyusXL4E47yYJ4p6JcYas6Dwxjxv7k2Z0NPwv7Q2IZo","origin_server_ts":1713991843968,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_4gmjbu31:reddit.com","type":"m.room.message","unsigned":{"age":2491969,"com_reddit_subreddit_id":"t5_2qyps"}},{"content":{"avatar_url":"","displayname":"luficer666999","membership":"join"},"event_id":"$0qBQ2C1OITHkAEBcpMkMrEOtxbkXMMtGCarkOqMOEEo","origin_server_ts":1713989667609,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_wl1sacuo0:reddit.com","state_key":"@t2_wl1sacuo0:reddit.com","type":"m.room.member","unsigned":{"age":4668328,"com_reddit_subreddit_id":"t5_2qyps"}},{"content":{"body":"So around 38?","msgtype":"m.text"},"event_id":"$EVXeYAyd2oukzaihM4Y-GGwCczZYnduV-p_DsHlkQhY","origin_server_ts":1713988388485,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_hrdlq4w:reddit.com","type":"m.room.message","unsigned":{"age":5947452,"com_reddit_subreddit_id":"t5_2qyps"}},{"content":{"body":"1987","msgtype":"m.text"},"event_id":"$b0cz7nbpx8jpY-uwL-alszYE7nhSJatboYQMiReCzXA","origin_server_ts":1713988377705,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_hrdlq4w:reddit.com","type":"m.room.message","unsigned":{"age":5958232,"com_reddit_subreddit_id":"t5_2qyps"}},{"content":{"body":"how old is it ?","msgtype":"m.text"},"event_id":"$SczZ4HglNlqz5s0dhE2GJSQOZSSrQ8uMU4Jl4wJITgc","origin_server_ts":1713988365317,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_kkw8yoro:reddit.com","type":"m.room.message","unsigned":{"age":5970620,"com_reddit_subreddit_id":"t5_2qyps"}},{"content":{"body":"Including that blue tuning dial","msgtype":"m.text"},"event_id":"$kg_dxikXY9-4A_txlJwSfpz0LQSDReAqOAZbzRAZokk","origin_server_ts":1713988327686,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_hrdlq4w:reddit.com","type":"m.room.message","unsigned":{"age":6008251,"com_reddit_subreddit_id":"t5_2qyps"}},{"content":{"body":"Restored it myself","msgtype":"m.text"},"event_id":"$c1SCOwlowbYSQk3_ZCc0uXOPIjClzigSin0BmTmoJHE","origin_server_ts":1713988315287,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_hrdlq4w:reddit.com","type":"m.room.message","unsigned":{"age":6020650,"com_reddit_subreddit_id":"t5_2qyps"}},{"content":{"body":"looks nice","msgtype":"m.text"},"event_id":"$VbRu_h3Ec4XT-WU00yoRMVlnLUo9hC5FbJGO6aJFr48","origin_server_ts":1713988305204,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_kkw8yoro:reddit.com","type":"m.room.message","unsigned":{"age":6030733,"com_reddit_subreddit_id":"t5_2qyps"}}],"updates":{},"state":[{"content":{"membership":"leave"},"event_id":"$93MPc1vv55z6B0LUgprh9W6dUM7TXspJf1pGnZdxMcc","origin_server_ts":1713992225977,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_kkw8yoro:reddit.com","state_key":"@t2_kkw8yoro:reddit.com","type":"m.room.member","unsigned":{"age":2109971,"com_reddit_subreddit_id":"t5_2qyps","prev_content":{"avatar_url":"","displayname":"MrRozo","membership":"join"},"prev_sender":"@t2_kkw8yoro:reddit.com","prev_stream_pos":1713987702911,"replaces_state":"$SahKtlyW1tUtigmIEsb5Fs-OU-_sR8amwmX5HBO280M"}},{"content":{"avatar_url":"","displayname":"tabadzija","membership":"join"},"event_id":"$_nBnMbkcrlrtq1-iugBRIKwlHimcLgvvBBGgHBuwZCc","origin_server_ts":1697918144116,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_4gmjbu31:reddit.com","state_key":"@t2_4gmjbu31:reddit.com","type":"m.room.member","unsigned":{"age":16076191832,"com_reddit_subreddit_id":"t5_2qyps"}},{"content":{"avatar_url":"","displayname":"luficer666999","membership":"join"},"event_id":"$0qBQ2C1OITHkAEBcpMkMrEOtxbkXMMtGCarkOqMOEEo","origin_server_ts":1713989667609,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_wl1sacuo0:reddit.com","state_key":"@t2_wl1sacuo0:reddit.com","type":"m.room.member","unsigned":{"age":4668339,"com_reddit_subreddit_id":"t5_2qyps"}},{"content":{"avatar_url":"","displayname":"ToniElectronics","membership":"join"},"event_id":"$juMzMBw-rcTEJe5zhDSiKz4qURw56pmOyAbWh2_3HjA","origin_server_ts":1698173360249,"room_id":"!GS8kU7qKTMydi5gBrShQtg:reddit.com","sender":"@t2_hrdlq4w:reddit.com","state_key":"@t2_hrdlq4w:reddit.com","type":"m.room.member","unsigned":{"age":15820975699,"com_reddit_subreddit_id":"t5_2qyps"}}]}
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>

#include <cJSON.h>

#include "messages.h"

ChunkContentInfo *parseChunkContentInfo(cJSON *info) {
    ChunkContentInfo *chunkContentInfo = malloc(sizeof(ChunkContentInfo));
    cJSON *h = cJSON_GetObjectItem(info, "h");
    chunkContentInfo->h = h ? h->valueint : 0;
    cJSON *mimetype = cJSON_GetObjectItem(info, "mimetype");
    chunkContentInfo->mimetype = mimetype ? mimetype->valuestring : NULL;
    cJSON *size = cJSON_GetObjectItem(info, "size");
    chunkContentInfo->size = size ? size->valueint : 0;
    cJSON *w = cJSON_GetObjectItem(info, "w");
    chunkContentInfo->w = w ? w->valueint : 0;
    return chunkContentInfo;
}

ChunkContent *parseChunkContent(cJSON *content) {
    ChunkContent *chunkContent = malloc(sizeof(ChunkContent));

    cJSON *membership = cJSON_GetObjectItem(content, "membership");
    chunkContent->membership = membership ? membership->valuestring : NULL;

    cJSON *avatar_url = cJSON_GetObjectItem(content, "avatar_url");
    chunkContent->avatar_url = avatar_url ? avatar_url->valuestring : NULL;

    cJSON *displayname = cJSON_GetObjectItem(content, "displayname");
    chunkContent->displayname = displayname ? displayname->valuestring : NULL;

    cJSON *msgtype = cJSON_GetObjectItem(content, "msgtype");
    chunkContent->msgtype = msgtype ? msgtype->valuestring : NULL;

    cJSON *body = cJSON_GetObjectItem(content, "body");
    chunkContent->body = body ? body->valuestring : NULL;

    cJSON *com_reddit_blurred_url = cJSON_GetObjectItem(content, "com.reddit.blurred_url");
    chunkContent->com_reddit_blurred_url = com_reddit_blurred_url ? com_reddit_blurred_url->valuestring : NULL;

    cJSON *com_reddit_nsfw_image = cJSON_GetObjectItem(content, "com.reddit.nsfw_image");
    chunkContent->com_reddit_nsfw_image = com_reddit_nsfw_image ? com_reddit_nsfw_image->valueint : 0;

    cJSON *info = cJSON_GetObjectItem(content, "info");
    chunkContent->info = info ? parseChunkContentInfo(info) : NULL;

    cJSON *url = cJSON_GetObjectItem(content, "url");
    chunkContent->url = url ? url->valuestring : NULL;

    return chunkContent;
}
ChunkUnsigned *parseChunkUnsigned(cJSON *unsigned_chunk) {
    ChunkUnsigned *chunkUnsigned = malloc(sizeof(ChunkUnsigned));

    cJSON *age = cJSON_GetObjectItem(unsigned_chunk, "age");
    chunkUnsigned->age = age ? age->valuedouble : 0;

    cJSON *com_reddit_subreddit_id = cJSON_GetObjectItem(unsigned_chunk, "com_reddit_subreddit_id");
    chunkUnsigned->com_reddit_subreddit_id = com_reddit_subreddit_id ? com_reddit_subreddit_id->valuestring : NULL;

    cJSON *prev_content = cJSON_GetObjectItem(unsigned_chunk, "prev_content");
    chunkUnsigned->prev_content = prev_content ? parseChunkContent(prev_content) : NULL;

    cJSON *prev_sender = cJSON_GetObjectItem(unsigned_chunk, "prev_sender");
    chunkUnsigned->prev_sender = prev_sender ? prev_sender->valuestring : NULL;

    cJSON *prev_stream_pos = cJSON_GetObjectItem(unsigned_chunk, "prev_stream_pos");
    chunkUnsigned->prev_stream_pos = prev_stream_pos ? prev_stream_pos->valuedouble : 0;

    cJSON *replaces_state = cJSON_GetObjectItem(unsigned_chunk, "replaces_state");
    chunkUnsigned->replaces_state = replaces_state ? replaces_state->valuestring : NULL;

    return chunkUnsigned;
}
struct MessageChunk* parseSingleChunk(cJSON* message) {
    MessageChunk *messageChunk = malloc(sizeof(MessageChunk));
    printf("Message: %s\n", cJSON_Print(message));

    cJSON *content = cJSON_GetObjectItem(message, "content");
    messageChunk->content = content ? parseChunkContent(content) : NULL;

    cJSON *event_id = cJSON_GetObjectItem(message, "event_id");
    messageChunk->event_id = event_id ? strdup(event_id->valuestring) : NULL;

    cJSON *origin_server_ts = cJSON_GetObjectItem(message, "origin_server_ts");
    messageChunk->origin_server_ts = origin_server_ts ? origin_server_ts->valuedouble : 0;

    cJSON *room_id = cJSON_GetObjectItem(message, "room_id");
    messageChunk->room_id = room_id ? strdup(room_id->valuestring) : NULL;

    cJSON *sender = cJSON_GetObjectItem(message, "sender");
    messageChunk->sender = sender ? strdup(sender->valuestring) : NULL;

    cJSON *state_key = cJSON_GetObjectItem(message, "state_key");
    messageChunk->state_key = state_key ? strdup(state_key->valuestring) : NULL;

    cJSON *type = cJSON_GetObjectItem(message, "type");
    messageChunk->type = type ? strdup(type->valuestring) : NULL;

    cJSON *unsigned_chunk = cJSON_GetObjectItem(message, "unsigned");
    messageChunk->unsigned_chunk = unsigned_chunk ? parseChunkUnsigned(unsigned_chunk) : NULL;

    return messageChunk;
}

MessageChunkArray* parseMessageChunk(cJSON* messages) {
    int size = cJSON_GetArraySize(messages);
    MessageChunk** messageChunks = malloc(size * sizeof(MessageChunk*));

    for (int i = 0; i < size; i++) {
        cJSON* message = cJSON_GetArrayItem(messages, i);
        messageChunks[i] = parseSingleChunk(message);
    }

    MessageChunkArray* result = malloc(sizeof(MessageChunkArray));
    result->chunks = messageChunks;
    result->size = size;

    return result;
}

MessageState *parseMessageState(cJSON *state) {
    MessageState *messageState = malloc(sizeof(MessageState));
    cJSON *content = cJSON_GetObjectItem(state, "content");
    cJSON *unsigned_chunk = cJSON_GetObjectItem(state, "unsigned");
    messageState->chunk = parseSingleChunk(content);
    return messageState;
}

MessageResponse *parseMessageResponse(char *response_body) {
    cJSON *root = cJSON_Parse(response_body);
    MessageResponse *messageResponse = malloc(sizeof(MessageResponse));
    messageResponse->start = cJSON_GetObjectItem(root, "start")->valuestring;
    messageResponse->start_stream = cJSON_GetObjectItem(root, "start_stream")->valuestring;
    messageResponse->end = cJSON_GetObjectItem(root, "end")->valuestring;
    cJSON *chunk = cJSON_GetObjectItem(root, "chunk");
    messageResponse->chunk = parseMessageChunk(chunk);
    messageResponse->updates = cJSON_GetObjectItem(root, "updates")->valuestring;
    cJSON *state = cJSON_GetObjectItem(root, "state");
    messageResponse->state = parseMessageState(state);
    return messageResponse;
}

Thread *parseThread(cJSON *threadJson) {
    Thread *thread = malloc(sizeof(Thread));
    cJSON *com_reddit_thread_heroes_user_ids = cJSON_GetObjectItem(threadJson, "com.reddit.thread.heroes_user_ids");
    int size = cJSON_GetArraySize(com_reddit_thread_heroes_user_ids);
    thread->com_reddit_thread_heroes_user_ids = malloc(size * sizeof(char *));
    for (int i = 0; i < size; i++) {
        cJSON *user_id = cJSON_GetArrayItem(com_reddit_thread_heroes_user_ids, i);
        thread->com_reddit_thread_heroes_user_ids[i] = user_id->valuestring;
    }
    thread->count = size;
    cJSON *current_user_participated = cJSON_GetObjectItem(threadJson, "current_user_participated");
    thread->current_user_participated = current_user_participated ? current_user_participated->valueint : 0;
    cJSON *latest_event = cJSON_GetObjectItem(threadJson, "latest_event");
    thread->latest_event = latest_event ? parseMessageChunk(latest_event) : NULL;
    return thread;
}
void printChunkContentInfo(ChunkContentInfo *info) {
    if (info) {
        printf("\n[Chunk Content Info]\n");
        printf("h: %d\n", info->h);
        if (info->mimetype) printf("mimetype: %s\n", info->mimetype);
        printf("size: %d\n", info->size);
        printf("w: %d\n", info->w);
    }
}

void printChunkContent(ChunkContent *content) {
    if (content) {
        printf("\n[Chunk Content]\n");
        if (content->membership) printf("membership: %s\n", content->membership);
        if (content->avatar_url) printf("avatar_url: %s\n", content->avatar_url);
        if (content->displayname) printf("displayname: %s\n", content->displayname);
        if (content->msgtype) printf("msgtype: %s\n", content->msgtype);
        if (content->body) printf("body: %s\n", content->body);
        if (content->com_reddit_blurred_url) printf("com_reddit_blurred_url: %s\n", content->com_reddit_blurred_url);
        printf("com_reddit_nsfw_image: %s\n", content->com_reddit_nsfw_image ? "true" : "false");
        if (content->info) {
            printf("info:\n");
            printChunkContentInfo(content->info);
        }
        if (content->url) printf("url: %s\n", content->url);
    }
}

void printChunkUnsigned(ChunkUnsigned *unsigned_chunk) {
    if (unsigned_chunk) {
        printf("\n[Chunk Unsigned]\n");
        printf("age: %f\n", unsigned_chunk->age);
        if (unsigned_chunk->com_reddit_subreddit_id) printf("com_reddit_subreddit_id: %s\n", unsigned_chunk->com_reddit_subreddit_id);
        if (unsigned_chunk->prev_content) {
            printf("prev_content:\n");
            printChunkContent(unsigned_chunk->prev_content);
        }
        if (unsigned_chunk->prev_sender) printf("prev_sender: %s\n", unsigned_chunk->prev_sender);
        printf("prev_stream_pos: %f\n", unsigned_chunk->prev_stream_pos);
        if (unsigned_chunk->replaces_state) printf("replaces_state: %s\n", unsigned_chunk->replaces_state);
    }
}

void printMessageChunk(MessageChunkArray *chunk) {
    //iterate over chunks
    for (int i = 0; i < chunk->size; i++) {
        printf("\n[Message Chunk %d]\n", i);
        printSingleChunk(chunk->chunks[i]);
    }
}

void printSingleChunk(MessageChunk *chunk) {
    if (chunk) {
        // create a divider for each chunk
        printf("\n--------------------------------------------------\n");
        if (chunk->content) {
            printf("content:\n");
            printChunkContent(chunk->content);
        }
        if (chunk->event_id) printf("\tevent_id: %s\n", chunk->event_id);
        printf("\torigin_server_ts: %f\n", chunk->origin_server_ts);
        if (chunk->room_id) printf("\troom_id: %s\n", chunk->room_id);
        if (chunk->sender) printf("\tsender: %s\n", chunk->sender);
        if (chunk->state_key) printf("\tstate_key: %s\n", chunk->state_key);
        if (chunk->type) printf("\ttype: %s\n", chunk->type);
        if (chunk->unsigned_chunk) {
            printf("\tunsigned_chunk:\n");
            printChunkUnsigned(chunk->unsigned_chunk);
        }
    }
}

void printMessageState(MessageState *state) {
    if (state) {
        printf("\n[Message State]\n");
        if (state->chunk) {
            printf("chunk:\n");
            printSingleChunk(state->chunk);
        }
    }
}

void printMessageResponse(MessageResponse *messageResponse) {
    if (messageResponse) {
        printf("\n[Message Response]\n");
        if (messageResponse->start) printf("start: %s\n", messageResponse->start);
        if (messageResponse->start_stream) printf("start_stream: %s\n", messageResponse->start_stream);
        if (messageResponse->end) printf("end: %s\n", messageResponse->end);
        if (messageResponse->chunk) {
            printf("chunk:\n");
            printMessageChunk(messageResponse->chunk);
        }
        if (messageResponse->updates) printf("updates: %s\n", messageResponse->updates);
        if (messageResponse->state) {
            printf("state:\n");
            printMessageState(messageResponse->state);
        }
    }
}